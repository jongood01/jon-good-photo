---
import { Image } from 'astro:assets'
import { getCollection } from 'astro:content'
import Button from './Button.astro'
import gradient from '../assets/gradient.svg'
import CloseIcon from '../assets/close-icon.svg'
import ArrowDownIcon from '../assets/arrow-down-icon.svg'
const images = await getCollection('photos')
---

<section id="gallery" class="lg:flex h-screen gap-6 snap-start snap-always">
  <div
    id="gallery-container"
    class="w-full max-w-[370px] pb-10 pt-[120px] overflow-y-scroll scroll-smooth px-5 lg:px-10 h-full flex flex-col gap-8 snap-mandatory snap-y scrollbar-hide"
  >
    <div class="gallery-image max-w-[320px] snap-center snap-always">
      <Image src={gradient} alt="gradient" width={320} height={320} loading="eager" />
      <div class="absolute bottom-2 left-0 right-0 text-center text-white text-sm">
        Scroll down <Image src={ArrowDownIcon} class="text-white inline-block" alt="scroll down" width={24} height={24} />
      </div>
    </div>

    {
      images.map(({ data }, index) => (
        <div class="w-fit flex relative">
          <button id={`thumbnail-${data.id}`} class="gallery-image thumbnail max-w-[320px] snap-center snap-always">
            <Image
              src={data.thumbnail}
              alt={data.altText || 'an image test'}
              width={320}
              height={320}
              quality={'max'}
              loading={index === 0 ? 'eager' : 'lazy'}
              oncontextmenu="return false"
            />
          </button>
          <div
            id={`format-${data.id}`}
            class="h-6 w-full absolute top-full left-full right-0 origin-top-left -rotate-90 flex justify-between transition-opacity duration-700 opacity-0"
          >
            <div>{data.format}</div>
            <div>
              {data.collectionIndex} • {data.categoryIndex} • {data.imageIndex}
            </div>
          </div>
        </div>
      ))
    }
    <div class="gallery-image max-w-[320px] snap-center snap-always">
      <Image src={gradient} alt="gradient" width={320} height={320} loading="lazy" />
    </div>
  </div>
  <div id="image-drawer" class="relative bg-white z-[100] h-full w-full overflow-y-scroll overflow-x-hidden scroll-smooth scrollbar-hide">
    {
      images.map(({ data }) => (
        <div
          id={`image-${data.id}`}
          class="transition-opacity duration-700 opacity-0 absolute top-20 lg:top-[120px] left-0 right-0 bottom-10 px-6 pb-20"
        >
          <div class="w-full">
            <Image
              src={data.file}
              alt={data.aspectRatio}
              widths={
                data.aspectRatio === '1:1'
                  ? [650, 1300]
                  : data.aspectRatio === '3:2'
                    ? [975, 1950]
                    : data.aspectRatio === '16:9'
                      ? [1156, 2312]
                      : [650, 1300]
              }
              height={650}
              sizes="(width <= 500px) 200px, (width <= 768px) 650px"
              quality={'high'}
              style={{ maxHeight: 'calc(100vh - 250px)' }}
              class="w-full h-auto object-contain object-left-top"
              oncontextmenu="return false"
            />

            <div class="pb-10">
              <h2 class="mt-4">{data.title}</h2>
              <p class="text-black/40 pb-4">{data.description}</p>
              <Button href={`/contact?photo=${data.id}`}>Enquire</Button>
            </div>
          </div>
        </div>
      ))
    }
    <button id="close-image-drawer-button" title="Close image" class="lg:hidden absolute top-2 right-2">
      <Image src={CloseIcon} alt="Close" width={24} height={24} loading="lazy" />
    </button>
  </div>
</section>
<div id="image-drawer-container" class="fixed top-0 left-0 bottom-0 right-0 bg-white/60"></div>
<script>
  const images = document.querySelectorAll<HTMLButtonElement>('.gallery-image')
  const gallery = document.getElementById('gallery-container')
  const imageDrawer = document.getElementById('image-drawer')
  const imageDrawerContainer = document.getElementById('image-drawer-container')
  const closeImageDrawerButton = document.getElementById('close-image-drawer-button')

  const handleClickOutsideDrawer = (e: MouseEvent | TouchEvent) => {
    let isImageClick = false
    images.forEach((image) => {
      if (image.contains(e.target as Node)) {
        isImageClick = true
      }
    })

    if (!imageDrawer?.contains(e.target as Node) && !isImageClick) {
      imageDrawer?.classList.remove('active')
      imageDrawerContainer?.classList.remove('active')
    }
  }

  const handleClickCloseDrawer = () => {
    imageDrawer?.classList.remove('active')
    imageDrawerContainer?.classList.remove('active')
  }

  const handleClickOpenDrawer = (e: MouseEvent | TouchEvent) => {
    if (!(e.currentTarget as HTMLButtonElement).classList.contains('active')) {
      return
    }

    imageDrawer?.classList.add('active')
    imageDrawerContainer?.classList.add('active')
  }

  const addListeners = () => {
    window.addEventListener('click', handleClickOutsideDrawer)
    window.addEventListener('touchend', handleClickOutsideDrawer)
    closeImageDrawerButton?.addEventListener('click', handleClickCloseDrawer)
    images.forEach((image) => {
      if (image.id) {
        image.addEventListener('click', handleClickOpenDrawer)
      }
    })
  }

  const removeListeners = () => {
    window.removeEventListener('click', handleClickOutsideDrawer)
    window.removeEventListener('touchend', handleClickOutsideDrawer)
    closeImageDrawerButton?.removeEventListener('click', handleClickCloseDrawer)
    images.forEach((image) => {
      if (image.id) {
        image.removeEventListener('click', handleClickOpenDrawer)
      }
    })
  }

  window.addEventListener('resize', () => {
    removeListeners()

    if (window.innerWidth < 1024) {
      addListeners()
    }
  })

  // Only add listeners for less than lg
  if (window.innerWidth < 1024) {
    addListeners()
  }

  // Header and footer visibility logic
  const header = document.getElementById('header')
  const main = document.getElementsByTagName('main')[0]
  const footer = document.getElementsByTagName('footer')[0]
  const gallerySection = document.getElementById('gallery')

  main?.addEventListener('scroll', () => {
    if (!footer || !gallerySection || !main || !header) return
    if (main.scrollTop >= gallerySection.offsetTop) {
      footer.style.opacity = '1'
      header.style.opacity = '1'
    } else {
      footer.style.opacity = '0'
      header.style.opacity = '0'
    }
  })

  gallery?.addEventListener('scroll', () => {
    images.forEach((image) => {
      const imageTop = image.getBoundingClientRect().top
      const imageBottom = image.getBoundingClientRect().bottom
      const id = image.id.replace('thumbnail-', 'image-')
      const formatId = image.id.replace('thumbnail-', 'format-')
      const fullSizeImage = document.getElementById(id)
      const formatDiv = document.getElementById(formatId)
      const windowCenter = window.innerHeight / 2
      const imageCenter = (imageTop + imageBottom) / 2
      const threshold = 200
      if (imageCenter > windowCenter - threshold && imageCenter < windowCenter + threshold) {
        image.classList.add('active')
        fullSizeImage?.classList.remove('opacity-0')
        fullSizeImage?.classList.add('opacity-100')
        formatDiv?.classList.remove('opacity-0')
        formatDiv?.classList.add('opacity-100')
      } else {
        image.classList.remove('active')
        fullSizeImage?.classList.remove('opacity-100')
        fullSizeImage?.classList.add('opacity-0')
        formatDiv?.classList.remove('opacity-100')
        formatDiv?.classList.add('opacity-0')
      }
    })
  })
</script>

<style is:global>
  #image-drawer {
    transform: translateY(0);
    transition: transform 0.3s ease-in-out;
  }

  #image-drawer.active {
    transform: translateY(-100%);
    z-index: 1200;
    transition: transform 0.3s ease-in-out;
  }

  #image-drawer-container {
    z-index: -1;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
  }

  #image-drawer-container.active {
    z-index: 1000;
    opacity: 1;
    transition: opacity 0.2s ease-in-out;
  }

  .gallery-image {
    position: relative;
  }

  .gallery-image::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    transition: background 0.5s ease-in;
  }

  .gallery-image.active::after {
    background: rgba(0, 0, 0, 0);
  }

  @media (max-width: 1024px) {
    .gallery-image.thumbnail {
      cursor: default;
    }

    .gallery-image.thumbnail.active {
      cursor: pointer;
    }
  }
</style>
